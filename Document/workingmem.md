# 工作记忆 (Working Memory)

工作记忆模拟人类的短期记忆机制，提供基于短期上下文的管理能力。它具有容量限制、时效性强、支持优先级管理和自动清理等特点。

## 核心特性

- **容量限制**：严格控制记忆条数和 Token 总数，防止上下文溢出。
- **时效性**：关注会话级别的近期记忆，支持 TTL（生存时间）自动过期。
- **优先级管理**：基于重要性和时间衰减计算优先级，自动淘汰低优先级记忆。
- **混合检索**：结合语义向量检索和关键词匹配，提供高精度的记忆召回。

## 数据结构

- **存储列表** (`memories: List[MemoryItem]`)：保存实际的记忆对象列表。
- **优先级堆** (`memory_heap`)：存储 `(priority, timestamp, memory_item)` 元组的最小堆，用于快速识别并移除低优先级记忆。

## 配置参数

| 参数 | 说明 | 默认值/来源 |
| :--- | :--- | :--- |
| `max_capacity` | 最大记忆条数 | 配置 `working_memory_capacity` |
| `max_tokens` | 最大 Token 数 | 配置 `working_memory_tokens` |
| `max_age_minutes` | 记忆生存时间（分钟） | 配置 `working_memory_ttl_minutes` (默认 120) |

## 核心机制

### 1. 添加记忆 (Add)

当添加新的工作记忆时，系统执行以下步骤：
1. **清理过期**：调用 `_expire_old_memories()` 清理已超过 `max_age_minutes` 的记忆。
2. **计算优先级**：结合记忆的重要性和时间因素计算优先级。
3. **更新存储**：将记忆加入列表和最小堆，并更新当前 Token 计数。
4. **强制容量限制**：如果超出条数或 Token 限制，根据优先级移除最不重要的记忆。

### 2. 检索记忆 (Retrieve)

检索过程采用混合策略，旨在找到最相关的短期记忆：
1. **预处理**：清理过期记忆，过滤掉标记为“已遗忘”的记忆，可选按 `user_id` 过滤。
2. **相关性计算**：
    - **向量检索**：使用 TF-IDF 和余弦相似度计算语义相似性（权重 0.7）。
    - **关键词匹配**：计算字符串包含或词组交集比例（权重 0.3）。
3. **综合评分**：
    - `基础相关度` = (向量分 * 0.7) + (关键词分 * 0.3)
    - `时间衰减` = 基于记忆产生时间计算衰减因子（每6小时衰减一次）。
    - `重要性加权` = 0.8 + (importance * 0.4)。
    - `最终分数` = 基础相关度 * 时间衰减 * 重要性加权。
4. **排序返回**：按最终分数降序排序，返回前 N 条。

### 3. 遗忘机制 (Forget)

支持多种遗忘策略，模拟人类遗忘过程：
- **TTL 自动过期**：始终执行，删除超过 `max_age_minutes` 的记忆。
- **基于重要性 (`importance_based`)**：删除重要性低于阈值的记忆。
- **基于时间 (`time_based`)**：删除超过指定天数的记忆（用于更长周期的清理）。
- **基于容量 (`capacity_based`)**：当超出容量时，删除优先级最低的记忆。

### 4. 上下文摘要 (Context Summary)

为 LLM 生成紧凑的上下文摘要：
1. 按 **重要性** 和 **时间戳** 降序排序（优先保留重要且新的记忆）。
2. **贪婪填充**：在 `max_length` 限制内尽可能多地包含记忆内容。
3. **智能截断**：对最后一条记忆进行字符级截断以适应剩余空间（保留至少 50 字符）。

## 内部算法细节

### 优先级计算 (`_calculate_priority`)
`优先级 = 记忆重要性 * 时间衰减因子`

### 时间衰减 (`_calculate_time_decay`)
采用指数衰减模型：
- **输入**：记忆产生至今的小时数。
- **公式**：`decay_factor ** (hours_passed / 6)`
- **说明**：记忆每经过 6 小时进行一次衰减，最低保持 10% 的权重。

### 容量控制 (`_enforce_capacity_limits`)
当记忆数量或 Token 数超出限制时，循环移除优先级最低的记忆（`_remove_lowest_priority_memory`），直到满足限制。
