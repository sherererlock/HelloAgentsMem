记忆抽象
    uersid:标识用户
    id:标识记忆
    content:记忆内容
    memorytype:记忆类型
    importance:记忆重要性
    timestamp:记忆时间
    metadata:记忆元数据

工作记忆

容量限制
    工作记忆的最大容量（token数）
    工作记忆的最大记忆项数

主要数据结构
    列表
    最小堆（优先级，时间戳）

添加工作记忆项
    工作记忆优先级计算规则：
        工作记忆项的优先级 = 记忆重要性 * 记忆时间权重
        记忆时间权重 =  (当前时间 - 记忆时间) / 6 小时 * 配置因子
    先根据容量限制，判断是否需要删除旧的记忆项，如果是，先基于容量后基于token清除低优先级的记忆
    计算新记忆项的优先级
    将新记忆项添加到工作记忆中

从工作记忆中检索记忆项
      
    工作记忆（Working Memory）的检索流程可以总结为以下四个主要阶段：

    **1. 预处理与初步过滤**
    - **清理过期记忆**：首先调用 `_expire_old_memories()` 移除超过生命周期的旧记忆。
    - **状态过滤**：排除标记为“已遗忘”（`forgotten: True`）的记忆项。
    - **用户隔离**：如果指定了 `user_id`，则仅保留属于该用户的记忆。

    **2. 混合检索计算**
    - **语义向量评分**：
        - 采用轻量级的 TF-IDF 算法将查询语句和记忆内容向量化。
        - 通过余弦相似度（Cosine Similarity）计算查询与每条记忆的语义相关性分数。
    - **关键词匹配评分**：
        - 进行基础的字符串包含校验。
        - 如果没有直接包含，则计算词组交集比例（Jaccard 相似度变形），作为关键词匹配分。

    **3. 多维度评分加权**
    - **混合相关性**：将向量分数（权重 0.7）与关键词分数（权重 0.3）融合。如果没有向量分数，则回退到纯关键词分。
    - **时间衰减（Recency）**：调用 `_calculate_time_decay`，根据记忆产生的时间戳降低旧记忆的分数，确保“越新鲜”的记忆权重越高。
    - **重要性加权（Importance）**：根据记忆存入时设定的 `importance` 属性进行加权（权重范围在 0.8 到 1.2 之间）。

    **4. 排序与截断**
    - **最终排序**：计算得出 `final_score` 后，过滤掉分数为 0 的项。
    - **返回结果**：按分数从高到低排序，并根据 `limit` 参数返回最相关的 Top-N 条记忆。

更新工作记忆项
    更新工作记忆项的步骤如下：
    1. 检查工作记忆中是否存在该记忆项。
    2. 如果存在，更新其内容、重要性、元数据等属性。
    3. 重新计算其优先级并更新最小堆。


删除工作记忆项
    删除工作记忆项的步骤如下：
    1. 检查工作记忆中是否存在该记忆项。
    2. 如果存在，从列表中删除该记忆项。
    3. 从最小堆中删除该记忆项（标记为已删除）。
    4. 更新当前 token 计数，减去该记忆项的 token 数。

遗忘记忆
    根据ttl（时间到了就遗忘），删除过期的记忆项
    根据传入的策略
        基于重要性
        基于时间
        基于容量

清理过期记忆
    检索，更新，添加，删除时都会先调用清理过期记忆的函数
    清理过期记忆的步骤如下：
    1. 遍历最小堆，检查每个记忆项的时间戳是否过期。
    2. 如果过期，从列表中删除该记忆项。
    3. 更新当前 token 计数，减去该记忆项的 token 数。

获取上下文摘要
    其核心逻辑可以总结为以下三步：

    **1. 启发式排序**
    - 函数首先对所有记忆进行降序排序（`reverse=True`）。
    - **排序权重**：优先考虑**重要性 (`importance`)**，其次考虑**时间戳 (`timestamp`)**。这意味着最重要且最新的信息会被排在最前面。

    **2. 贪婪长度控制**
    - 遍历排序后的记忆，逐条累加到摘要中。
    - **长度硬限制**：通过 `max_length`（默认 500 字符）严格控制总长度。
    - **智能截断**：如果某条记忆加入后会超过限制，函数会计算剩余空间。如果空间还足够（>50 字符），它会截断该条记忆的开头部分并加上省略号，而不是直接丢弃。

    **3. 格式化输出**
    - 最终将筛选出的记忆片段用换行符连接。
    - 返回一个带有 `Working Memory Context:` 前缀的字符串。

    **总结**：这是一个**资源受限型**的上下文提取函数，它通过牺牲“次要且陈旧”的信息，确保在有限的 Token 窗口内向 AI 提供质量最高的短期背景资料。
